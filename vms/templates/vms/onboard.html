{% extends "vms/base.html" %}
{% block content %}
<div class="card p-4 shadow-sm">
  <h2 class="mb-3">Onboard an Organization into the Data Space</h2>
  <p><strong>Scenario 1:</strong> Organization <em>Volunet</em> requests to join the VMS Data Space.
     The Data Space Governance Authority (DSGA) will check the required metadata, validate trust, review the catalog, and perform ontology mapping.</p>

  <!-- DSGA Requirements -->
  <div class="alert alert-info">
    <h5 class="mb-2">Data Space Self-description (DSSD):</h5>
    <ul class="mb-0">
      <li>Basic metadata (name, contact)</li>
      <li>Privacy policy</li>
      <li>Organization’s catalog (events to share)</li>
      <li>Schema.org ontology mapping the skills to ESCO in JSON-LD format</li>
      <li>Contract acceptance</li>
    </ul>
  </div>
  <h4 class="mb-3">Participant Self-description (PSD):</h4>

<form id="onboard-form" class="mb-4" novalidate>
  <label class="form-label" for="org-name">Organization name
    <span title="The legal or common name of the organization">ℹ️</span>
  </label>
  <input id="org-name" class="form-control" name="name" value="Volunet" autocomplete="organization">

  <label class="form-label" for="org-email">Contact email
    <span title="Contact point for governance and technical issues">ℹ️</span>
  </label>
  <input id="org-email" type="email" class="form-control" name="contact_email" value="volunet@gmail.org" autocomplete="email">

  <label class="form-label" for="org-connector">Connector endpoint
    <span title="Base URL of the organization's dataspace connector (where its catalog and events are published)">ℹ️</span>
  </label>
  <input id="org-connector" type="url" class="form-control" name="connector_endpoint" value="https://connector.volunet.edc/" autocomplete="url">

  <label class="form-label" for="org-privacy">Privacy policy URL
    <span title="Public statement about how data will be processed and protected">ℹ️</span>
  </label>
  <input id="org-privacy" type="url" class="form-control" name="privacy_policy_url" value="https://volunet.contracts/privacy" autocomplete="url">

  <button class="btn btn-success mt-2">DSGA Registry Function</button>
</form>

<h4>DSGA Log</h4>
<pre id="onboard-log" class="bg-dark text-light p-3 rounded small" style="max-height:250px; overflow:auto;">
Waiting for submission...
</pre>

<div id="catalog-section" class="mt-4" style="display:none;">
  <h4>Approved Catalog</h4>
  <div id="catalog-view" class="list-group"></div>
</div>
</div>

{% endblock %}
{% block extra_js %}
<script>
function collectCatalog() {
  const rows = document.querySelectorAll("#catalog-table tr");
  let items = [];
  rows.forEach((r,i) => {
    if (i === 0) return;
    const title = r.cells[0].querySelector("input").value;
    const skills = r.cells[1].querySelector("input").value.split(",").map(s => s.trim());
    const hours = parseInt(r.cells[2].querySelector("input").value);
    items.push({id: "item"+i, title, skills, hours});
  });
  return items;
}

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("onboard-form");
  form.addEventListener("submit", async function(ev){
    ev.preventDefault();
    const data = {
      name: form.name.value,
      contact_email: form.contact_email.value,
      connector_endpoint: form.connector_endpoint.value,
      privacy_policy_url: form.privacy_policy_url.value,
      {#catalog_sample: collectCatalog()#}
    };

    const logBox = document.getElementById("onboard-log");
    logBox.innerText = "▶ Submitting onboarding request...\n";

    try {
      const res = await fetch("{% url 'vms:api_onboard_organization' %}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      const j = await res.json();

        if (j.status === "approved") {
          logBox.innerText += "✔ Approved by DSGA\n\n";

          // Show volunteer schema mappings
            logBox.innerText += "Volunteer Schema Mapping:\n";
            j.volunteer_schema.forEach(m => {
              logBox.innerText += `   ${m.local_field} → ${m.mapped_to}  ("${m.sample_value}")\n`;
            });

            // Show normalized JSON-LD example
            logBox.innerText += "\nNormalized Volunteer (Volunteer Schema compliant):\n";
            logBox.innerText += JSON.stringify(j.normalized_example, null, 2) + "\n";

            // Show ESCO-enriched skills in a nicer way
            if (j.esco_skills && j.esco_skills.length > 0) {
              logBox.innerText += "\nESCO Skill Mapping:\n";
              j.esco_skills.forEach(s => {
                logBox.innerText += `• ${s.label} → ${s.uri}\n`;
                if (s.description) {
                  logBox.innerText += `   ${s.description}\n`;
                }
              });
            }

            // Show policy contracts
            logBox.innerText += "\nPolicy Contracts & Usage Agreements:\n";
            Object.entries(j.policy_contracts).forEach(([section, terms]) => {
              logBox.innerText += `  ${section}:\n`;
              Object.entries(terms).forEach(([k, v]) => {
                logBox.innerText += `    - ${k}: ${JSON.stringify(v)}\n`;
              });
            });

          // Show exposed endpoints
            logBox.innerText += "\nExposed EDC Endpoints:\n";
            logBox.innerText += `Catalog: ${j.endpoints.catalog}\n`;
            j.endpoints.events.forEach(ev => {
              logBox.innerText += `• ${ev.title} → ${ev.endpoint}\n`;
            });

            // After skill mappings
            logBox.innerText += "\nCertificate issued: " + j.certificate_thumbprint + "\n";

            // Show catalog
        const cRes = await fetch(`/api/catalog/${j.organization_id}/`);
        const catalog = await cRes.json();
        const view = document.getElementById("catalog-view");
        view.innerHTML = "";

        // Show the full catalog endpoint first
        const allItem = document.createElement("div");
        allItem.className = "list-group-item list-group-item-info";
        allItem.innerHTML = `
          <em>Full Catalog Endpoint</em><br>
          <code>${catalog.endpoints.catalog}</code>
        `;
        view.appendChild(allItem);

        // Show each event endpoint
        catalog.endpoints.events.forEach(ev => {
          const item = document.createElement("div");
          item.className = "list-group-item";
          item.innerHTML = `
            <strong>${ev.title}</strong><br>
            Endpoint: <code>${ev.endpoint}</code>
          `;
          view.appendChild(item);
        });

        document.getElementById("catalog-section").style.display = "block";

      } else {
        logBox.innerText += "✖ Rejected: " + j.reason + "\n";
      }
    } catch (err) {
      logBox.innerText += "⚠ Error: " + err + "\n";
    }
  });
});
</script>
{% endblock %}
